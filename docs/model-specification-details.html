<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Model specification details | pdmphmc - numerical generalized randomized HMC processes for R</title>
  <meta name="description" content="Description in index.Rmd" />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Model specification details | pdmphmc - numerical generalized randomized HMC processes for R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Description in index.Rmd" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Model specification details | pdmphmc - numerical generalized randomized HMC processes for R" />
  
  <meta name="twitter:description" content="Description in index.Rmd" />
  

<meta name="author" content="Tore Selland Kleppe" />


<meta name="date" content="2023-07-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="the-model-specification.html"/>
<link rel="next" href="constraints.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#what-is-pdmphmc"><i class="fa fa-check"></i><b>1.1</b> What is <code>pdmphmc</code>?</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#why-pdmphmc"><i class="fa fa-check"></i><b>1.2</b> Why <code>pdmphmc</code>?</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i><b>1.3</b> Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="pdmphmc-hello-world.html"><a href="pdmphmc-hello-world.html"><i class="fa fa-check"></i><b>2</b> <code>pdmphmc</code> “Hello World”</a>
<ul>
<li class="chapter" data-level="2.1" data-path="pdmphmc-hello-world.html"><a href="pdmphmc-hello-world.html#requirements"><i class="fa fa-check"></i><b>2.1</b> Requirements</a></li>
<li class="chapter" data-level="2.2" data-path="pdmphmc-hello-world.html"><a href="pdmphmc-hello-world.html#check-your-installation"><i class="fa fa-check"></i><b>2.2</b> Check your installation</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="the-model-specification.html"><a href="the-model-specification.html"><i class="fa fa-check"></i><b>3</b> The model specification</a>
<ul>
<li class="chapter" data-level="3.1" data-path="the-model-specification.html"><a href="the-model-specification.html#simple-worked-example"><i class="fa fa-check"></i><b>3.1</b> A simple worked example</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="model-specification-details.html"><a href="model-specification-details.html"><i class="fa fa-check"></i><b>4</b> Model specification details</a>
<ul>
<li class="chapter" data-level="4.1" data-path="model-specification-details.html"><a href="model-specification-details.html#data_-statements"><i class="fa fa-check"></i><b>4.1</b> <code>DATA_*</code> statements</a></li>
<li class="chapter" data-level="4.2" data-path="model-specification-details.html"><a href="model-specification-details.html#the-preprocess-function"><i class="fa fa-check"></i><b>4.2</b> The <code>preProcess()</code> function</a></li>
<li class="chapter" data-level="4.3" data-path="model-specification-details.html"><a href="model-specification-details.html#the-operator-function"><i class="fa fa-check"></i><b>4.3</b> The <code>operator()()</code> function</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="model-specification-details.html"><a href="model-specification-details.html#the-parameter_-macros"><i class="fa fa-check"></i><b>4.3.1</b> The <code>PARAMETER_*</code> macros</a></li>
<li class="chapter" data-level="4.3.2" data-path="model-specification-details.html"><a href="model-specification-details.html#specifying-the-shape-of-piboldsymbol-theta."><i class="fa fa-check"></i><b>4.3.2</b> Specifying the shape of <span class="math inline">\(\pi(\boldsymbol \theta)\)</span>.</a></li>
<li class="chapter" data-level="4.3.3" data-path="model-specification-details.html"><a href="model-specification-details.html#generated-quantities"><i class="fa fa-check"></i><b>4.3.3</b> Generated quantities</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="constraints.html"><a href="constraints.html"><i class="fa fa-check"></i><b>5</b> Constraints</a>
<ul>
<li class="chapter" data-level="5.1" data-path="constraints.html"><a href="constraints.html#specifying-constraints"><i class="fa fa-check"></i><b>5.1</b> Specifying constraints</a></li>
<li class="chapter" data-level="5.2" data-path="constraints.html"><a href="constraints.html#special-constraints"><i class="fa fa-check"></i><b>5.2</b> Special constraints</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="constraints.html"><a href="constraints.html#dense-linear-constraints"><i class="fa fa-check"></i><b>5.2.1</b> Dense Linear constraints</a></li>
<li class="chapter" data-level="5.2.2" data-path="constraints.html"><a href="constraints.html#sparse-linear-constraints"><i class="fa fa-check"></i><b>5.2.2</b> Sparse Linear constraints</a></li>
<li class="chapter" data-level="5.2.3" data-path="constraints.html"><a href="constraints.html#sparse-linear-l1-constraints"><i class="fa fa-check"></i><b>5.2.3</b> Sparse Linear <span class="math inline">\(L^1\)</span> constraints</a></li>
<li class="chapter" data-level="5.2.4" data-path="constraints.html"><a href="constraints.html#sparse-linear-l2-constraints"><i class="fa fa-check"></i><b>5.2.4</b> Sparse Linear <span class="math inline">\(L^2\)</span> constraints</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="constraints.html"><a href="constraints.html#non-linear-constraints"><i class="fa fa-check"></i><b>5.3</b> Non-linear constraints</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="constraints.html"><a href="constraints.html#constraint-functor-details"><i class="fa fa-check"></i><b>5.3.1</b> Details of the constraint functor</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="constraints.html"><a href="constraints.html#worked-example"><i class="fa fa-check"></i><b>5.4</b> Worked example</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="constraints.html"><a href="constraints.html#linear-constraints-dense-and-sparse"><i class="fa fa-check"></i><b>5.4.1</b> Linear constraints (dense and sparse)</a></li>
<li class="chapter" data-level="5.4.2" data-path="constraints.html"><a href="constraints.html#l1-constraint"><i class="fa fa-check"></i><b>5.4.2</b> <span class="math inline">\(L^1\)</span> constraint</a></li>
<li class="chapter" data-level="5.4.3" data-path="constraints.html"><a href="constraints.html#l2-constraint"><i class="fa fa-check"></i><b>5.4.3</b> <span class="math inline">\(L^2\)</span> constraint</a></li>
<li class="chapter" data-level="5.4.4" data-path="constraints.html"><a href="constraints.html#general-nonlinear-constraint"><i class="fa fa-check"></i><b>5.4.4</b> General nonlinear constraint</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="amt-lib.html"><a href="amt-lib.html"><i class="fa fa-check"></i><b>6</b> The <code>amt</code>-library</a>
<ul>
<li class="chapter" data-level="6.1" data-path="amt-lib.html"><a href="amt-lib.html#amt-SPD-matrix"><i class="fa fa-check"></i><b>6.1</b> Utilities for symmetric positive definite matrices</a></li>
<li class="chapter" data-level="6.2" data-path="amt-lib.html"><a href="amt-lib.html#univariate-continuous-distributions"><i class="fa fa-check"></i><b>6.2</b> Univariate continuous distributions</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="amt-lib.html"><a href="amt-lib.html#expgamma_ldargshapescale"><i class="fa fa-check"></i><b>6.2.1</b> <code>expGamma_ld(arg,shape,scale)</code></a></li>
<li class="chapter" data-level="6.2.2" data-path="amt-lib.html"><a href="amt-lib.html#invlogitbeta_ldxab"><i class="fa fa-check"></i><b>6.2.2</b> <code>invLogitBeta_ld(x,a,b)</code></a></li>
<li class="chapter" data-level="6.2.3" data-path="amt-lib.html"><a href="amt-lib.html#invlogituniform_ldx"><i class="fa fa-check"></i><b>6.2.3</b> <code>invLogitUniform_ld(x)</code></a></li>
<li class="chapter" data-level="6.2.4" data-path="amt-lib.html"><a href="amt-lib.html#normal_ldargmeansd"><i class="fa fa-check"></i><b>6.2.4</b> <code>normal_ld(arg,mean,sd)</code></a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="amt-lib.html"><a href="amt-lib.html#univariate-discrete-distributions"><i class="fa fa-check"></i><b>6.3</b> Univariate discrete distributions</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="amt-lib.html"><a href="amt-lib.html#bernoulli_logit_lmyalpha"><i class="fa fa-check"></i><b>6.3.1</b> <code>bernoulli_logit_lm(y,alpha)</code></a></li>
<li class="chapter" data-level="6.3.2" data-path="amt-lib.html"><a href="amt-lib.html#poisson_log_lmyeta"><i class="fa fa-check"></i><b>6.3.2</b> <code>poisson_log_lm(y,eta)</code></a></li>
<li class="chapter" data-level="6.3.3" data-path="amt-lib.html"><a href="amt-lib.html#zipoisson_log_lmyetag"><i class="fa fa-check"></i><b>6.3.3</b> <code>ziPoisson_log_lm(y,eta,g)</code></a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="amt-lib.html"><a href="amt-lib.html#distributions-on-unbounded-vectors"><i class="fa fa-check"></i><b>6.4</b> Distributions on unbounded vectors</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="amt-lib.html"><a href="amt-lib.html#multi_normal_prec_ldargmuprec"><i class="fa fa-check"></i><b>6.4.1</b> <code>multi_normal_prec_ld(arg,mu,Prec)</code></a></li>
<li class="chapter" data-level="6.4.2" data-path="amt-lib.html"><a href="amt-lib.html#iid_multi_normal_prec_ldargmuprec"><i class="fa fa-check"></i><b>6.4.2</b> <code>iid_multi_normal_prec_ld(arg,mu,Prec)</code></a></li>
<li class="chapter" data-level="6.4.3" data-path="amt-lib.html"><a href="amt-lib.html#multi_normal_ldargmusigma"><i class="fa fa-check"></i><b>6.4.3</b> <code>multi_normal_ld(arg,mu,Sigma)</code></a></li>
<li class="chapter" data-level="6.4.4" data-path="amt-lib.html"><a href="amt-lib.html#normalar1_ldargmuphisigma"><i class="fa fa-check"></i><b>6.4.4</b> <code>normalAR1_ld(arg,mu,phi,sigma)</code></a></li>
<li class="chapter" data-level="6.4.5" data-path="amt-lib.html"><a href="amt-lib.html#normalrw1_ldxsigma"><i class="fa fa-check"></i><b>6.4.5</b> <code>normalRW1_ld(x,sigma)</code></a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="amt-lib.html"><a href="amt-lib.html#distributions-on-symmetric-positive-definite-matrices"><i class="fa fa-check"></i><b>6.5</b> Distributions on symmetric positive definite matrices</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="amt-lib.html"><a href="amt-lib.html#wishartdiagscale_ldargscalediagdf"><i class="fa fa-check"></i><b>6.5.1</b> <code>wishartDiagScale_ld(arg,scaleDiag,df)</code></a></li>
<li class="chapter" data-level="6.5.2" data-path="amt-lib.html"><a href="amt-lib.html#wishartrw1_ldargmeannu"><i class="fa fa-check"></i><b>6.5.2</b> <code>wishartRW1_ld(arg,mean,nu)</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="the-samplers.html"><a href="the-samplers.html"><i class="fa fa-check"></i><b>7</b> The sampling algorithms</a>
<ul>
<li class="chapter" data-level="7.1" data-path="the-samplers.html"><a href="the-samplers.html#fixed-mass-sampler"><i class="fa fa-check"></i><b>7.1</b> Fixed mass sampler</a></li>
<li class="chapter" data-level="7.2" data-path="the-samplers.html"><a href="the-samplers.html#Riemann-manifold"><i class="fa fa-check"></i><b>7.2</b> Riemann manifold sampler</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="the-samplers.html"><a href="the-samplers.html#metric-tensor-storage"><i class="fa fa-check"></i><b>7.2.1</b> Metric tensor storage</a></li>
<li class="chapter" data-level="7.2.2" data-path="the-samplers.html"><a href="the-samplers.html#advanced"><i class="fa fa-check"></i><b>7.2.2</b> Advanced</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="the-samplers.html"><a href="the-samplers.html#ODE-solvers"><i class="fa fa-check"></i><b>7.3</b> ODE solvers</a></li>
<li class="chapter" data-level="7.4" data-path="the-samplers.html"><a href="the-samplers.html#scaling-adaptation"><i class="fa fa-check"></i><b>7.4</b> Scaling adaptation</a></li>
<li class="chapter" data-level="7.5" data-path="the-samplers.html"><a href="the-samplers.html#event-intensity"><i class="fa fa-check"></i><b>7.5</b> Event intensity</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="worked-examples.html"><a href="worked-examples.html"><i class="fa fa-check"></i><b>8</b> Worked examples</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">pdmphmc - numerical generalized randomized HMC processes for <code>R</code></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="model-specification-details" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">Chapter 4</span> Model specification details<a href="model-specification-details.html#model-specification-details" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="data_-statements" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> <code>DATA_*</code> statements<a href="model-specification-details.html#data_-statements" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The facility for passing data from <code>R</code> to the model is based on the <code>DATA_*</code> preprocessor macros. Currently there are 6 types of these, corresponding to different types of C++ storage in the model:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb26-1"><a href="model-specification-details.html#cb26-1" aria-hidden="true" tabindex="-1"></a>DATA_DOUBLE<span class="op">(&lt;</span>dataname<span class="op">&gt;);</span> <span class="co">// C++ storage: double </span></span>
<span id="cb26-2"><a href="model-specification-details.html#cb26-2" aria-hidden="true" tabindex="-1"></a>DATA_INT<span class="op">(&lt;</span>dataname<span class="op">&gt;);</span> <span class="co">// C++ storage: int </span></span>
<span id="cb26-3"><a href="model-specification-details.html#cb26-3" aria-hidden="true" tabindex="-1"></a>DATA_VECTOR<span class="op">(&lt;</span>dataname<span class="op">&gt;);</span> <span class="co">// C++ storage: Eigen::VectorXd </span></span>
<span id="cb26-4"><a href="model-specification-details.html#cb26-4" aria-hidden="true" tabindex="-1"></a>DATA_IVECTOR<span class="op">(&lt;</span>dataname<span class="op">&gt;);</span> <span class="co">// C++ storage: Eigen::VectorXi </span></span>
<span id="cb26-5"><a href="model-specification-details.html#cb26-5" aria-hidden="true" tabindex="-1"></a>DATA_MATRIX<span class="op">(&lt;</span>dataname<span class="op">&gt;);</span> <span class="co">// C++ storage: Eigen::MatrixXd </span></span>
<span id="cb26-6"><a href="model-specification-details.html#cb26-6" aria-hidden="true" tabindex="-1"></a>DATA_IMATRIX<span class="op">(&lt;</span>dataname<span class="op">&gt;);</span> <span class="co">// C++ storage: Eigen::MatrixXi </span></span></code></pre></div>
<p>After putting one or multiple <code>DATA_*</code> statements at the <strong>start of the model class</strong>, a object with name <code>&lt;dataname&gt;</code> and the indicated type will be available throughout the class.</p>
<p>The objects initiated with <code>DATA_*</code> statements are filled using the <code>data</code> argument of the <code>pdmphmc::run</code> function. E.g. if the model class contains</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb27-1"><a href="model-specification-details.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> model<span class="op">{</span></span>
<span id="cb27-2"><a href="model-specification-details.html#cb27-2" aria-hidden="true" tabindex="-1"></a>  DATA_DOUBLE<span class="op">(</span>dd<span class="op">);</span></span>
<span id="cb27-3"><a href="model-specification-details.html#cb27-3" aria-hidden="true" tabindex="-1"></a>  DATA_MATRIX<span class="op">(</span>mat<span class="op">);</span></span>
<span id="cb27-4"><a href="model-specification-details.html#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// rest of model spec here</span></span>
<span id="cb27-5"><a href="model-specification-details.html#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>then calls to <code>pdmphmc::run</code> must be done with
something like</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="model-specification-details.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># assuming the model has been built into R-variable &quot;model&quot;</span></span>
<span id="cb28-2"><a href="model-specification-details.html#cb28-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">run</span>(model,<span class="at">data=</span><span class="fu">list</span>(<span class="at">dd=</span><span class="fl">1.23</span>,<span class="at">mat=</span><span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">4</span>),<span class="dv">2</span>,<span class="dv">2</span>)))</span></code></pre></div>
<p>The data are read into the C++ program before any sampling etc is done.</p>
</div>
<div id="the-preprocess-function" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> The <code>preProcess()</code> function<a href="model-specification-details.html#the-preprocess-function" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>preProcess()</code> is intended for restructuring data, reading data directly from a file etc.</p>
<p>The pre-process function gets called after data are read into C++/is available as objects <code>&lt;dataname&gt;</code>. E.g. continuing the example above, e.g.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb29-1"><a href="model-specification-details.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> model<span class="op">{</span></span>
<span id="cb29-2"><a href="model-specification-details.html#cb29-2" aria-hidden="true" tabindex="-1"></a>  DATA_DOUBLE<span class="op">(</span>dd<span class="op">);</span></span>
<span id="cb29-3"><a href="model-specification-details.html#cb29-3" aria-hidden="true" tabindex="-1"></a>  DATA_MATRIX<span class="op">(</span>mat<span class="op">);</span></span>
<span id="cb29-4"><a href="model-specification-details.html#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="va">ddHalf_</span><span class="op">;</span></span>
<span id="cb29-5"><a href="model-specification-details.html#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> preProcess<span class="op">(){</span></span>
<span id="cb29-6"><a href="model-specification-details.html#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">ddHalf_</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">*</span>dd<span class="op">;</span></span>
<span id="cb29-7"><a href="model-specification-details.html#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb29-8"><a href="model-specification-details.html#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// rest of model spec here</span></span>
<span id="cb29-9"><a href="model-specification-details.html#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>the variable <code>ddHalf_</code> would contain <code>0.5*1.23</code> at the time of sampling if the same data as above are provided.</p>
</div>
<div id="the-operator-function" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> The <code>operator()()</code> function<a href="model-specification-details.html#the-operator-function" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>operator()()</code> function is used for specifying (in a broad sense) the target distribution, say <span class="math inline">\(\pi(\boldsymbol \theta)\)</span>.</p>
<p>It should have the signature:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb30-1"><a href="model-specification-details.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span> <span class="kw">class</span> varType<span class="op">,</span> <span class="kw">class</span> tensorType<span class="op">,</span> <span class="dt">bool</span> storeNames<span class="op">&gt;</span></span>
<span id="cb30-2"><a href="model-specification-details.html#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span>amt<span class="op">::</span>amtModel<span class="op">&lt;</span>varType<span class="op">,</span>tensorType<span class="op">,</span>storeNames<span class="op">&gt;</span> <span class="op">&amp;</span>model__<span class="op">){</span></span>
<span id="cb30-3"><a href="model-specification-details.html#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>The particular meaning of the templates etc is not important, but the
user should be aware that all parameters, and all quantities depending
on parameters should be of type <code>varType</code><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. <code>varType</code>s could be used more
or less as <code>double</code> types in C++.</p>
<p>Further, the user should be aware of the <code>amt::amtModel</code> object by default named <code>model__</code><a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>. The <code>amt::amtModel</code> object keeps track of the names and dimensions of the parameters etc, the value of log-target distribution and so on.</p>
<p><code>operator()</code> typically consist of three parts:</p>
<ul>
<li>specifying the sampled quantities <span class="math inline">\(\boldsymbol \theta\)</span> using <code>PARAMETER_*</code> macros.</li>
<li>specifying the shape of the target distribution <span class="math inline">\(\pi(\boldsymbol \theta)\)</span>.</li>
<li>specifying other quantities of interest for which samples are recorded.</li>
</ul>
<p>In what follows, each of these point are discussed in more detail:</p>
<div id="the-parameter_-macros" class="section level3 hasAnchor" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> The <code>PARAMETER_*</code> macros<a href="model-specification-details.html#the-parameter_-macros" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The sampled quantities (e.g. parameters, latent variables and so on) are specified using the <code>PARAMETER_*</code> macros:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb31-1"><a href="model-specification-details.html#cb31-1" aria-hidden="true" tabindex="-1"></a>PARAMETER_SCALAR<span class="op">(&lt;</span>name<span class="op">&gt;,...);</span> <span class="co">// C++ storage: varType</span></span>
<span id="cb31-2"><a href="model-specification-details.html#cb31-2" aria-hidden="true" tabindex="-1"></a>PARAMETER_VECTOR<span class="op">(&lt;</span>name<span class="op">&gt;,</span>dim<span class="op">,...);</span> </span>
<span id="cb31-3"><a href="model-specification-details.html#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">// C++ storage: Eigen::Matrix&lt;varType,Eigen::Dynamic,1&gt;  </span></span>
<span id="cb31-4"><a href="model-specification-details.html#cb31-4" aria-hidden="true" tabindex="-1"></a>PARAMETER_MATRIX<span class="op">(</span>name<span class="op">,</span>dim1<span class="op">,</span>dim2<span class="op">,...);</span> </span>
<span id="cb31-5"><a href="model-specification-details.html#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">// C++ storage: Eigen::Matrix&lt;varType,Eigen::Dynamic,Eigen::Dynamic&gt;</span></span>
<span id="cb31-6"><a href="model-specification-details.html#cb31-6" aria-hidden="true" tabindex="-1"></a>PARAMETER_SPD_MATRIX<span class="op">(</span>name<span class="op">,</span>dim<span class="op">,...);</span></span>
<span id="cb31-7"><a href="model-specification-details.html#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">// C++ storage: amt::SPDmatrix&lt;varType&gt;</span></span></code></pre></div>
<p>All of these macros presume that the argument to the <code>operator()</code>-function is named <code>model__</code>. After a call to e.g. <code>PARAMETER_VECTOR(&lt;name&gt;,dim,...);</code>, a vector of <code>varType</code>s of dimension <code>dim</code> and with name <code>&lt;name&gt;</code> will be available subsequently.</p>
<p>The <code>SPDmatrix</code>class template is further explained in Chapter <a href="amt-lib.html#amt-SPD-matrix">6.1</a></p>
<p>An optional argument - the default value - may be passed to each of the
<code>PARAMETER_*</code> macros. The default value is used when initiating the sampling, and <strong>it is important that <span class="math inline">\(\pi(\boldsymbol \theta)\)</span> is defined when <span class="math inline">\(\boldsymbol \theta\)</span> corresponds to the default values</strong>. If no default values is provided, the default value is implicitly set to <span class="math inline">\(0\)</span>.</p>
<p>(Non-zero) default values could be either <code>double</code> scalars which are repeated to fill non-scalar variables, e.g.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb32-1"><a href="model-specification-details.html#cb32-1" aria-hidden="true" tabindex="-1"></a>PARAMETER_VECTOR<span class="op">(</span>mu<span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="fl">1.0</span><span class="op">);</span><span class="co">// mu is intiated at (1.0,1.0,1.0,1.0)</span></span></code></pre></div>
<p>Otherwise, the default values may be vectors/matrices of the same dimension(s) as the parameter, e.g.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb33-1"><a href="model-specification-details.html#cb33-1" aria-hidden="true" tabindex="-1"></a>Eigen<span class="op">::</span>Vector muDefault<span class="op">(</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb33-2"><a href="model-specification-details.html#cb33-2" aria-hidden="true" tabindex="-1"></a>muDefault<span class="op">.</span>setZero<span class="op">();</span></span>
<span id="cb33-3"><a href="model-specification-details.html#cb33-3" aria-hidden="true" tabindex="-1"></a>muDefault<span class="op">(</span><span class="dv">3</span><span class="op">)</span> <span class="op">=</span> <span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb33-4"><a href="model-specification-details.html#cb33-4" aria-hidden="true" tabindex="-1"></a>PARAMETER_VECTOR<span class="op">(</span>mu<span class="op">,</span>muDefault<span class="op">.</span>size<span class="op">(),</span>muDefault<span class="op">);</span></span>
<span id="cb33-5"><a href="model-specification-details.html#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co">// mu is intiated at (0.0,0.0,0.0,2.0)</span></span></code></pre></div>
<p>One may even pass the dimension and default values of the parameters using the <code>DATA_*</code>:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb34-1"><a href="model-specification-details.html#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> model<span class="op">{</span></span>
<span id="cb34-2"><a href="model-specification-details.html#cb34-2" aria-hidden="true" tabindex="-1"></a>  DATA_VECTOR<span class="op">(</span>dvec<span class="op">);</span></span>
<span id="cb34-3"><a href="model-specification-details.html#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> preProcess<span class="op">(){}</span></span>
<span id="cb34-4"><a href="model-specification-details.html#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;</span> <span class="kw">class</span> varType<span class="op">,</span> <span class="kw">class</span> tensorType<span class="op">,</span> <span class="dt">bool</span> storeNames<span class="op">&gt;</span></span>
<span id="cb34-5"><a href="model-specification-details.html#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span>amt<span class="op">::</span>amtModel<span class="op">&lt;</span>varType<span class="op">,</span>tensorType<span class="op">,</span>storeNames<span class="op">&gt;</span> <span class="op">&amp;</span>model__<span class="op">){</span></span>
<span id="cb34-6"><a href="model-specification-details.html#cb34-6" aria-hidden="true" tabindex="-1"></a>    PARAMETER_VECTOR<span class="op">(</span>d<span class="op">,</span>dvec<span class="op">.</span>size<span class="op">(),</span>dvec<span class="op">);</span></span>
<span id="cb34-7"><a href="model-specification-details.html#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// d will have the dimension of dvec, and default values=dvec</span></span>
<span id="cb34-8"><a href="model-specification-details.html#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// rest of model spec here</span></span>
<span id="cb34-9"><a href="model-specification-details.html#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb34-10"><a href="model-specification-details.html#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Note that there are no facilities for specifying that certain elements <span class="math inline">\(\boldsymbol \theta\)</span> to be restricted to a certain range (e.g. positive). Hence the user is responsible for ensuring that suitable transformations are made to avoid numerical problems. See e.g. the log-transformation of the standard deviation in the example in Section <a href="the-model-specification.html#simple-worked-example">3.1</a></p>
</div>
<div id="specifying-the-shape-of-piboldsymbol-theta." class="section level3 hasAnchor" number="4.3.2">
<h3><span class="header-section-number">4.3.2</span> Specifying the shape of <span class="math inline">\(\pi(\boldsymbol \theta)\)</span>.<a href="model-specification-details.html#specifying-the-shape-of-piboldsymbol-theta." class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Specifying the shape of the target distribution is done using various overloaded <code>+=</code> operators applied to the <code>amt::amtModel</code> object. It is assumed that <span class="math inline">\(\log \pi(\boldsymbol \theta)\)</span> may be written as the sum of
several log-densities.</p>
<p>Two sets of such log-densities are available:</p>
<ul>
<li><p>For fixed metric samplers and Riemannian samplers (see Chapter (ref:the-samplers) for details), a library of
log-densities with names ending with <code>_ld</code> or <code>_lm</code> are available under namesspace <code>amt</code>. These are further documented in Chapter <a href="amt-lib.html#amt-lib">6</a></p></li>
<li><p>For fixed metric samplers only, the complete set of <code>stan::math</code> functions with names ending with <code>_lpdf</code> or <code>_lpmf</code> (see <a href="https://mc-stan.org/docs/functions-reference/index.html" class="uri">https://mc-stan.org/docs/functions-reference/index.html</a>) are available</p></li>
</ul>
<p>Below are two examples, both specifying a 4-dimensional standard normal target distribution:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb35-1"><a href="model-specification-details.html#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">//...</span></span>
<span id="cb35-2"><a href="model-specification-details.html#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;</span> <span class="kw">class</span> varType<span class="op">,</span> <span class="kw">class</span> tensorType<span class="op">,</span> <span class="dt">bool</span> storeNames<span class="op">&gt;</span></span>
<span id="cb35-3"><a href="model-specification-details.html#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span>amt<span class="op">::</span>amtModel<span class="op">&lt;</span>varType<span class="op">,</span>tensorType<span class="op">,</span>storeNames<span class="op">&gt;</span> <span class="op">&amp;</span>model__<span class="op">){</span></span>
<span id="cb35-4"><a href="model-specification-details.html#cb35-4" aria-hidden="true" tabindex="-1"></a>    PARAMETER_VECTOR<span class="op">(</span>x<span class="op">,</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb35-5"><a href="model-specification-details.html#cb35-5" aria-hidden="true" tabindex="-1"></a>    model__ <span class="op">+=</span> normal_ld<span class="op">(</span>x<span class="op">,</span><span class="fl">0.0</span><span class="op">,</span><span class="fl">1.0</span><span class="op">);</span> <span class="co">// amt version</span></span>
<span id="cb35-6"><a href="model-specification-details.html#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb35-7"><a href="model-specification-details.html#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">//...</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb36-1"><a href="model-specification-details.html#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">//...</span></span>
<span id="cb36-2"><a href="model-specification-details.html#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;</span> <span class="kw">class</span> varType<span class="op">,</span> <span class="kw">class</span> tensorType<span class="op">,</span> <span class="dt">bool</span> storeNames<span class="op">&gt;</span></span>
<span id="cb36-3"><a href="model-specification-details.html#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span>amt<span class="op">::</span>amtModel<span class="op">&lt;</span>varType<span class="op">,</span>tensorType<span class="op">,</span>storeNames<span class="op">&gt;</span> <span class="op">&amp;</span>model__<span class="op">){</span></span>
<span id="cb36-4"><a href="model-specification-details.html#cb36-4" aria-hidden="true" tabindex="-1"></a>    PARAMETER_VECTOR<span class="op">(</span>x<span class="op">,</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb36-5"><a href="model-specification-details.html#cb36-5" aria-hidden="true" tabindex="-1"></a>    model__ <span class="op">+=</span> stan<span class="op">::</span>math<span class="op">::</span>normal_lpdf<span class="op">(</span>x<span class="op">,</span><span class="fl">0.0</span><span class="op">,</span><span class="fl">1.0</span><span class="op">);</span> <span class="co">// stan::math version</span></span>
<span id="cb36-6"><a href="model-specification-details.html#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb36-7"><a href="model-specification-details.html#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co">//...</span></span></code></pre></div>
<p>Further, more elaborate examples of model specifications are provided in Chapter <a href="worked-examples.html#worked-examples">8</a>.</p>
</div>
<div id="generated-quantities" class="section level3 hasAnchor" number="4.3.3">
<h3><span class="header-section-number">4.3.3</span> Generated quantities<a href="model-specification-details.html#generated-quantities" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Generated quantities are used in two ways:</p>
<ul>
<li><p>It is often the case that one is interested in the posterior distribution of some auxiliary quantities which depend on the parameter <span class="math inline">\(\boldsymbol \theta\)</span>.</p></li>
<li><p>The <code>pdmphmc</code> package has the capability to compute “time-integrated” samples (see e.g. <span class="citation">Kleppe (<a href="#ref-kleppe_CTHMC" role="doc-biblioref">2022a</a>)</span>, Equation 7 and Figure 3), which in certain cases may be much more efficient for estimating certain moments. Time integrated samples are computed for all generated quantities (and not the parameters, so if you want time-integrated samples of the parameters, pass them as generated quantities).</p></li>
</ul>
<p>To record such quantities, the <code>generated()</code> function (member of <code>amt::amtModel</code>) is used. There are several overloads of <code>generated()</code> allowing several types (scalars, vectors, matrices etc.) to be passed.</p>
<p>The <code>generated()</code> functions have signatures similar to
<code>inline void generated(const &lt;SOME TYPE&gt;&amp; value,const std::string&amp; name)</code>, where <code>&lt;SOME TYPE&gt;</code> is a C++ type/template, such as e.g. <code>double</code>, <code>Eigen::VectorXd</code> or <code>varType</code>. <code>name</code> is the name used for the generated quantity in the output.</p>
<p>Below is a complete example of the usage. First, the content of file <code>generated_model.cpp</code>:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb37-1"><a href="model-specification-details.html#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> amt<span class="op">;</span></span>
<span id="cb37-2"><a href="model-specification-details.html#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="model-specification-details.html#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> quadNorm<span class="op">(</span><span class="at">const</span> Eigen<span class="op">::</span>VectorXd<span class="op">&amp;</span> x<span class="op">){</span></span>
<span id="cb37-4"><a href="model-specification-details.html#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span><span class="op">(</span>x<span class="op">.</span>dot<span class="op">(</span>x<span class="op">));</span></span>
<span id="cb37-5"><a href="model-specification-details.html#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb37-6"><a href="model-specification-details.html#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="model-specification-details.html#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> model<span class="op">{</span></span>
<span id="cb37-8"><a href="model-specification-details.html#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> preProcess<span class="op">(){}</span> <span class="co">// not used in this example </span></span>
<span id="cb37-9"><a href="model-specification-details.html#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;</span> <span class="kw">class</span> varType<span class="op">,</span> <span class="kw">class</span> tensorType<span class="op">,</span> <span class="dt">bool</span> storeNames<span class="op">&gt;</span></span>
<span id="cb37-10"><a href="model-specification-details.html#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span>amt<span class="op">::</span>amtModel<span class="op">&lt;</span>varType<span class="op">,</span>tensorType<span class="op">,</span>storeNames<span class="op">&gt;</span> <span class="op">&amp;</span>model__<span class="op">){</span></span>
<span id="cb37-11"><a href="model-specification-details.html#cb37-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-12"><a href="model-specification-details.html#cb37-12" aria-hidden="true" tabindex="-1"></a>    PARAMETER_VECTOR<span class="op">(</span>x<span class="op">,</span><span class="dv">4</span><span class="op">);</span> <span class="co">// parameter (sampled quantity)</span></span>
<span id="cb37-13"><a href="model-specification-details.html#cb37-13" aria-hidden="true" tabindex="-1"></a>    model__<span class="op">+=</span>normal_ld<span class="op">(</span>x<span class="op">,</span><span class="fl">0.0</span><span class="op">,</span><span class="fl">1.0</span><span class="op">);</span> <span class="co">// add standard normal log-density</span></span>
<span id="cb37-14"><a href="model-specification-details.html#cb37-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-15"><a href="model-specification-details.html#cb37-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-16"><a href="model-specification-details.html#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// make the whole parameter a generated</span></span>
<span id="cb37-17"><a href="model-specification-details.html#cb37-17" aria-hidden="true" tabindex="-1"></a>    model__<span class="op">.</span>generated<span class="op">(</span>asDouble<span class="op">(</span>x<span class="op">),</span><span class="st">&quot;x_gen&quot;</span><span class="op">);</span> </span>
<span id="cb37-18"><a href="model-specification-details.html#cb37-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// different transformations of x to be recored:</span></span>
<span id="cb37-19"><a href="model-specification-details.html#cb37-19" aria-hidden="true" tabindex="-1"></a>    model__<span class="op">.</span>generated<span class="op">(</span><span class="bu">std::</span>pow<span class="op">(</span>asDouble<span class="op">(</span>x<span class="op">(</span><span class="dv">0</span><span class="op">)),</span><span class="dv">3</span><span class="op">),</span><span class="st">&quot;x1_cube&quot;</span><span class="op">);</span></span>
<span id="cb37-20"><a href="model-specification-details.html#cb37-20" aria-hidden="true" tabindex="-1"></a>    model__<span class="op">.</span>generated<span class="op">(</span>exp<span class="op">(</span>asDouble<span class="op">(</span>x<span class="op">(</span><span class="dv">1</span><span class="op">))),</span><span class="st">&quot;x2_exp&quot;</span><span class="op">);</span></span>
<span id="cb37-21"><a href="model-specification-details.html#cb37-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-22"><a href="model-specification-details.html#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> qn <span class="op">=</span> quadNorm<span class="op">(</span>asDouble<span class="op">(</span>x<span class="op">));</span></span>
<span id="cb37-23"><a href="model-specification-details.html#cb37-23" aria-hidden="true" tabindex="-1"></a>    model__<span class="op">.</span>generated<span class="op">(</span>qn<span class="op">,</span><span class="st">&quot;quadraticNorm&quot;</span><span class="op">);</span></span>
<span id="cb37-24"><a href="model-specification-details.html#cb37-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-25"><a href="model-specification-details.html#cb37-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> </span>
<span id="cb37-26"><a href="model-specification-details.html#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="op">};</span> <span class="co">// end of struct</span></span></code></pre></div>
<p>Note that it is good practice to provide <code>double</code> values as the first argument to <code>generated()</code>. The double value of AD types <code>varType</code> obtains using the <code>asDouble()</code> function.</p>
<p>Then build and run the model:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="model-specification-details.html#cb38-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> pdmphmc<span class="sc">::</span><span class="fu">build</span>(<span class="st">&quot;generated_model.cpp&quot;</span>)</span></code></pre></div>
<pre><code>## model name : model</code></pre>
<pre><code>## process type : HMCProcessConstr</code></pre>
<pre><code>## Runge Kutta step type : RKDP54</code></pre>
<pre><code>## Transport map type : diagLinearTM_VARI</code></pre>
<pre><code>## compilation exited successfully</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="model-specification-details.html#cb44-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> pdmphmc<span class="sc">::</span><span class="fu">run</span>(model)</span>
<span id="cb44-2"><a href="model-specification-details.html#cb44-2" aria-hidden="true" tabindex="-1"></a>pdmphmc<span class="sc">::</span><span class="fu">clean.model</span>(model,<span class="at">remove.all =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="model-specification-details.html#cb46-1" aria-hidden="true" tabindex="-1"></a>fit</span></code></pre></div>
<pre><code>## run output for model: model</code></pre>
<pre><code>## # of chains : 4</code></pre>
<pre><code>## Summary based on discrete samples:</code></pre>
<pre><code>##                 mean se_mean    sd n_eff  Rhat
## x[1]          -0.003   0.017 0.977  3301 1.004
## x[2]          -0.007   0.018 1.035  3495 1.003
## x[3]          -0.001   0.017 1.014  3640 0.999
## x[4]           0.002   0.017 0.973  3397 1.002
## x_gen[1]      -0.003   0.017 0.977  3301 1.004
## x_gen[2]      -0.007   0.018 1.035  3495 1.003
## x_gen[3]      -0.001   0.017 1.014  3640 0.999
## x_gen[4]       0.002   0.017 0.973  3397 1.002
## x1_cube       -0.001   0.063 3.797  3599 1.005
## x2_exp         1.697   0.040 2.345  3415 1.002
## quadraticNorm  4.000   0.070 2.845  1661 1.002</code></pre>
<pre><code>## summary based on integrated samples:</code></pre>
<pre><code>##               estimate se_estimate n_eff  Rhat
## x_gen[1]         0.005       0.005  6235 1.004
## x_gen[2]         0.003       0.005  5887 1.002
## x_gen[3]         0.004       0.005  6369 1.003
## x_gen[4]        -0.002       0.005  5919 1.000
## x1_cube          0.016       0.018  6310 1.007
## x2_exp           1.708       0.037   982 1.003
## quadraticNorm    4.020       0.068   826 1.003</code></pre>
<pre><code>## NOTE: integrated samples do NOT reflect the complete target distibution, only indicated moments with respect to the target distribution</code></pre>
<p>It is seen that discrete time samples (which reflect target distribution) are recorded (by default) for the parameters (in this case <code>x[1]</code>,…,<code>x[4]</code>) and the generated quantities (here <code>x_gen[1]</code>,…,<code>x_gen[4]</code>,<code>x1_cube</code>,<code>x2_exp</code>,<code>quadraticNorm</code>).</p>
<p>Integrated samples for calculating moments with respect to the target distribution are recorded for the generated quantities only.</p>
<p>Some minor comments related to performance are in order here:</p>
<ul>
<li><p>As seen in the example above, <code>double</code> values (or vectors or matrices thereof) should ideally be passed to the <code>generated()</code> functions. This is in order of avoiding unnecessary AD computations. In particular, if the generated function is a complicated function of the parameters (for which function <code>quadNorm()</code> may serve as a placeholder), the computations leading up to the generated quantity should be done in double-variables.</p></li>
<li><p>In models where <span class="math inline">\(\boldsymbol \theta\)</span> is high-dimensional and parts of <span class="math inline">\(\boldsymbol \theta\)</span> are of less interest, the default behavior of storing samples of all of <span class="math inline">\(\boldsymbol \theta\)</span> may be overridden by using the <code>store.pars</code> argument in <code>pdmphmc::run()</code>. Reducing the number of stored quantities leads to both memory savings and savings in terms of computing time.</p></li>
</ul>

</div>
</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-kleppe_CTHMC" class="csl-entry">
———. 2022a. <span>“Connecting the Dots: Numerical Randomized <span>H</span>amiltonian <span>M</span>onte <span>C</span>arlo with State-Dependent Event Rates.”</span> <em>Journal of Computational and Graphical Statistics</em>.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>So far, <code>varType</code> is either of type <code>stan::math::var</code> or <code>amt::amtVar</code> (see header <code>include/amt/amtVar.hpp</code>).<a href="model-specification-details.html#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>In principle it could be named something else, but this will break the <code>PARAMETER_*</code>-macros discussed below. Hence, if the argument to <code>operator()</code> is named something else, the user should provide calls similar to those defined by these macros (see <code>include/amt.hpp</code>)<a href="model-specification-details.html#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="the-model-specification.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="constraints.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
